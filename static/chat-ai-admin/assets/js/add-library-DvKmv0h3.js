import{_ as te,L as he,d as z,M as be,ax as Y,ay as xe,N as we,O as ke,c as qe,B as Ne}from"../../index-1XZddRjh.js";import{r as y,w as Ae,L as d,M as v,a8 as j,j as t,Q as n,V as c,P as q,u as k,a3 as le,a4 as ne,$ as Ce,A as H,v as Oe,U as A,F as M,a1 as E,a2 as R,Y as w,E as B,G as V,X as b,a7 as Se}from"./vue-chunks-DrvJJrR0.js";import{U as Ue}from"./upload-input-CIar8cpb.js";import{c as Le}from"./index-jkbC24gP.js";import{c as Fe}from"./index-Y6-zlOHq.js";import{F as K,_ as Ie}from"./index-NfbGWbde.js";import{P as Pe}from"./PlusOutlined-CLu6l5b3.js";import{_ as Me}from"./index-DZeMyMzw.js";import{t as oe}from"./validate-8MtiUsxW.js";import"./index-DTthLzpm.js";import{I as Ee}from"./Input-LEQ1nsBA.js";import"./index-C0hP31Jf.js";import{R as je,_ as De}from"./RadioButton-BlkUcbKS.js";import{_ as Te}from"./TextArea-B0gFiJOu.js";import{S as $e,_ as Re,a as Be}from"./index-Xdyh2PDp.js";import{_ as Ve}from"./index-CGIhWGiI.js";import"./dayjs-Bv4VEw_C.js";import"./axios-Cm0UX6qg.js";import"./qs-QntUJHOZ.js";import"./crypto-js-BpV8n4kc.js";import"./colors-HGJN4rtO.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./responsiveObserve-BmeIIMjk.js";import"./collapseMotion-DfZt1qrJ.js";import"./index-COlk-g_h.js";import"./QuestionCircleOutlined-RuyTLEvr.js";import"./FormItemContext-Ddh0y1W5.js";import"./Password-i_NKyCZh.js";import"./inputProps-CcY99FcL.js";import"./CheckOutlined-DhJk9Bd7.js";import"./useRefs-Bj34oM9A.js";import"./index-BX9E5auJ.js";import"./Search-CBq09XDz.js";import"./SearchOutlined-Bmx9sA_A.js";import"./index-BY3kojOB.js";import"./slide-DiBPL1Vu.js";import"./DownOutlined-B1nKfHNN.js";import"./move-BfDFh-Ii.js";const ze=g=>(le("data-v-9db3840d"),g=g(),ne(),g),Je={class:"avatar-uploader"},Ge=["src"],Qe=ze(()=>c("div",{class:"ant-upload-text"},"上传照片",-1)),Xe=["src"],Ye={__name:"avatar-input",props:{value:{type:String,default:""}},emits:["update:value","change"],setup(g,{emit:J}){function D(r){return new Promise((N,S)=>{const u=new FileReader;u.readAsDataURL(r),u.onload=()=>N(u.result),u.onerror=I=>S(I)})}const U=J,L=g,C=y([]),T=y(!1),F=y("");Ae(()=>L.value,r=>{F.value=r},{immediate:!0});const G=K.useInjectFormItemContext(),Q=()=>{let r={imageUrl:F.value,file:C.value[0].originFileObj};U("change",r),U("update:value",r.imageUrl),G.onFieldChange()},O=r=>r.type==="image/jpeg"||r.type==="image/png"?r.size/1024<100?(C.value=[r],D(r).then(u=>{F.value=u,T.value=!1,Q()}),!1):(z.error("知识库封面图片大小不能超过100kb"),!1):(z.error("知识库封面只支持JPG、PNG格式的图片"),!1),p=y(!1),x=y(""),e=y(""),$=()=>{p.value=!1,e.value=""},W=async r=>{!r.url&&!r.preview&&(r.preview=await D(r.originFileObj)),x.value=r.url||r.preview,p.value=!0,e.value=r.name||r.url.substring(r.url.lastIndexOf("/")+1)};return(r,N)=>{const S=Me,u=be;return d(),v("div",Je,[g.value?(d(),v("img",{key:0,class:"avatar",src:g.value,alt:"avatar"},null,8,Ge)):j("",!0),t(S,{class:"upload-upload","file-list":C.value,"onUpdate:fileList":N[0]||(N[0]=I=>C.value=I),"list-type":"picture-card","show-upload-list":!1,"before-upload":O,accept:".jpg,.png,.jpeg",onPreview:W},{default:n(()=>[c("div",null,[T.value?(d(),q(k(he),{key:0})):(d(),q(k(Pe),{key:1})),Qe])]),_:1},8,["file-list"]),t(u,{open:p.value,title:e.value,footer:null,onCancel:$},{default:n(()=>[c("img",{alt:"example",style:{width:"100%"},src:x.value},null,8,Xe)]),_:1},8,["open","title"])])}}},He=te(Ye,[["__scopeId","data-v-9db3840d"]]),Ke=g=>(le("data-v-7010608b"),g=g(),ne(),g),We={class:"add-library-page"},Ze={class:"form-box"},ea=Ke(()=>c("div",{class:"form-item-tip"},"请上传知识库封面，建议尺寸为100*100px.大小不超过100kb",-1)),aa={class:"upload-document-type-box"},oa=["onClick"],ta={class:"right-block"},la={class:"title-block"},na={class:"title-text"},ia={class:"desc"},ra={class:"upload-document-type-box"},sa=["onClick"],da={class:"right-block"},ca={class:"title-block"},_a={class:"title-text"},ua={class:"desc"},ma={class:"card-box"},pa=["onClick"],fa=["src"],va={key:0},ya={key:1},ga={__name:"add-library",setup(g){const{getStorage:J,setStorage:D}=xe("localStorage");z.config({duration:2});const U=Ce(),L=["azure","ollama","xinference","openaiAgent"],C=["azure"],T=y([{iconName:"high",iconNameActive:"high-active",title:"高质量",value:1,is_offline:!1,desc:"使用在线的嵌入模型，在召回时具有更高的准确度，但需要花费token"},{iconName:"economic",iconNameActive:"economic-active",title:"经济",value:2,is_offline:!0,desc:"使用离线的向量模型，较在线模型准确度稍低，但是不需要消耗token"}]),F=y([{iconName:"doc-icon",iconNameActive:"doc-icon-active",title:"本地文档",value:1,desc:"上传本地 text/pdf/doc/docx/xlsx 等格式文件"},{iconName:"link-icon",iconNameActive:"link-icon-active",title:"在线数据",value:2,desc:"获取在线网页内容"},{iconName:"cu-doc-icon",iconNameActive:"cu-doc-active",title:"自定义文档",value:3,desc:"自定义一个空文档，手动添加或编辑内容"}]),G=y([{iconName:"file-search",iconNameActive:"file-search",title:"问题与答案一起生成索引",value:1,desc:"回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复"},{iconName:"comment-search",iconNameActive:"comment-search",title:"仅对问题生成索引",value:2,desc:"回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复"}]),Q=K.useForm,O=y(!1),p=H(J("lastEmbeddedModel")||{}),x=y(p.isActive?p.isActive:2),e=H({library_name:"",library_intro:"",use_model:p.use_model?p.use_model:void 0,model_config_id:p.model_config_id?p.model_config_id:"",library_files:void 0,avatar:Y,robot_avatar_url:Y,is_offline:Object.prototype.hasOwnProperty.call(p,"is_offline")?p.is_offline:!1,urls:"",doc_type:1,file_name:"",is_qa_doc:0,qa_index_type:1,doc_auto_renew_frequency:1}),$=y(""),N=H({library_name:[{required:!0,message:"请输入库名称",trigger:"change"}],library_intro:[{required:!0,message:"请输入库简介",trigger:"change"}],use_model:[{required:!0,message:"请选择嵌入模型",trigger:"change"}],library_files:[{required:!0,message:"请选择文件",trigger:"change",validator:(o,l)=>l&&l.length>0||e.doc_type!=1?Promise.resolve():Promise.reject(new Error("请上传文件"))}],urls:[{required:!0,validator:(o,l)=>e.doc_type!=2?Promise.resolve():oe(l)===!1?Promise.reject(new Error("网页地址不合法")):Promise.resolve()}],file_name:[{required:!0,validator:(o,l)=>e.doc_type!=3||l?Promise.resolve():Promise.reject(new Error("请输入文档名称"))}]}),{validate:S,validateInfos:u}=Q(e,N),I=o=>{e.library_files=o},ie=(o,l)=>{const m=l.current_obj;e.use_model=L.indexOf(m.model_define)>-1&&m.deployment_name?m.deployment_name:m.name,$.value=m.model_define,e.model_config_id=m.id||l.model_config_id},re=o=>{e.avatar=o.file},se=o=>{e.is_offline=o.is_offline,x.value=o.value,e.use_model=void 0,X(o.is_offline)},de=o=>{e.doc_type=o},ce=o=>{e.qa_index_type=o},_e=()=>{U.back()},ue=()=>{S().then(()=>{me()}).catch(o=>{})},me=()=>{let o=new FormData,l=JSON.parse(JSON.stringify(e));C.indexOf($.value)>-1&&(l.use_model="默认"),o.append("library_name",e.library_name),o.append("library_intro",e.library_intro),o.append("use_model",l.use_model),o.append("model_config_id",e.model_config_id),o.append("avatar",e.avatar||Y),o.append("is_offline",e.is_offline),o.append("urls",JSON.stringify(oe(e.urls))),o.append("doc_type",e.doc_type),o.append("file_name",e.file_name),o.append("is_qa_doc",e.is_qa_doc),o.append("qa_index_type",e.qa_index_type),o.append("doc_auto_renew_frequency",e.doc_auto_renew_frequency),D("lastEmbeddedModel",{model_config_id:e.model_config_id,is_offline:e.is_offline,use_model:e.use_model,isActive:x.value});let m=!1;e.doc_type==1&&e.library_files.forEach(i=>{(i.name.includes(".xlsx")||i.name.includes(".csv"))&&(m=!0),o.append("library_files",i)}),O.value=!0,Le(o).then(i=>{z.success("创建成功");let s="/library/details/knowledge-document",_={id:i.data.id};m&&(s="/library/document-segmentation",_={document_id:i.data.file_ids[0]}),e.doc_type==3&&(s="/library/preview",_={id:i.data.file_ids[0]}),U.replace({path:s,query:_}),O.value=!1}).catch(()=>{O.value=!1})},P=y([]);function pe(o,l,m){const i=new Set(o.map(s=>s.model_define));return l.filter(s=>{let _=s[m];i.has(_)&&o.filter(h=>{if(h.model_define==_)return h.children=ke(h.children,s.children),!1})}),o}const X=o=>{Fe({model_type:"TEXT EMBEDDING",is_offline:o}).then(l=>{let m=l.data||[],i=[];P.value=m.map(s=>{i=[];for(let _=0;_<s.model_info.vector_model_list.length;_++){const h=s.model_info.vector_model_list[_];i.push({name:h,deployment_name:s.model_config.deployment_name,id:s.model_config.id,model_define:s.model_info.model_define})}return{id:s.model_config.id,name:s.model_info.model_name,model_define:s.model_info.model_define,icon:s.model_info.model_icon_url,children:i,deployment_name:s.model_config.deployment_name}}),P.value=pe(we(P.value,"model_define"),P.value,"model_define")})};return Oe(()=>{Object.prototype.hasOwnProperty.call(p,"is_offline")?X(p.is_offline):X(!0)}),(o,l)=>{const m=Ee,i=Ie,s=Te,_=qe,h=$e,Z=Re,ee=je,fe=De,ve=Ve,ye=Be,ae=Ne,ge=K;return d(),v("div",We,[c("div",Ze,[t(ge,{"label-col":{span:5}},{default:n(()=>[t(i,A({ref:"name",label:"知识库名称"},k(u).library_name),{default:n(()=>[t(m,{value:e.library_name,"onUpdate:value":l[0]||(l[0]=a=>e.library_name=a),placeholder:"请输入知识库名称，最多20个字"},null,8,["value"])]),_:1},16),t(i,A({label:"知识库简介"},k(u).library_intro),{default:n(()=>[t(s,{value:e.library_intro,"onUpdate:value":l[1]||(l[1]=a=>e.library_intro=a),placeholder:"请输入知识库介绍"},null,8,["value"])]),_:1},16),t(i,A({ref:"name",label:"知识库封面"},k(u).robot_avatar_url),{default:n(()=>[t(He,{value:e.robot_avatar_url,"onUpdate:value":l[2]||(l[2]=a=>e.robot_avatar_url=a),onChange:re},null,8,["value"]),ea]),_:1},16),t(i,{label:"导入文档类型",required:""},{default:n(()=>[c("div",aa,[(d(!0),v(M,null,E(F.value,a=>(d(),v("div",{class:R(["type-item",{active:e.doc_type==a.value}]),key:a.value,onClick:f=>de(a.value)},[c("div",ta,[c("div",la,[t(_,{name:e.doc_type==a.value?a.iconNameActive:a.iconName},null,8,["name"]),c("div",na,w(a.title),1)]),c("div",ia,w(a.desc),1)]),e.doc_type==a.value?(d(),q(_,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):j("",!0)],10,oa))),128))])]),_:1}),B(t(i,A({ref:"name",label:"知识库文档"},k(u).library_files),{default:n(()=>[t(Ue,{onChange:I})]),_:1},16),[[V,e.doc_type==1]]),B(t(i,A({ref:"urls",label:"网页链接"},k(u).urls),{default:n(()=>[t(s,{style:{height:"120px"},value:e.urls,"onUpdate:value":l[3]||(l[3]=a=>e.urls=a),placeholder:"请输入网页链接,形式：一行标题一行网页链接"},null,8,["value"])]),_:1},16),[[V,e.doc_type==2]]),B(t(i,{ref:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:n(()=>[t(Z,{value:e.doc_auto_renew_frequency,"onUpdate:value":l[4]||(l[4]=a=>e.doc_auto_renew_frequency=a),style:{width:"100%"}},{default:n(()=>[t(h,{value:1},{default:n(()=>[b("不自动更新")]),_:1}),t(h,{value:2},{default:n(()=>[b("每天")]),_:1}),t(h,{value:3},{default:n(()=>[b("每3天")]),_:1}),t(h,{value:4},{default:n(()=>[b("每7天")]),_:1}),t(h,{value:5},{default:n(()=>[b("每30天")]),_:1})]),_:1},8,["value"])]),_:1},512),[[V,e.doc_type==2]]),B(c("div",null,[t(i,A({ref:"file_name",label:"文档名称"},k(u).file_name),{default:n(()=>[t(m,{placeholder:"请输入文档名称",value:e.file_name,"onUpdate:value":l[5]||(l[5]=a=>e.file_name=a)},null,8,["value"])]),_:1},16),t(i,{label:"文档类型",required:""},{default:n(()=>[t(fe,{value:e.is_qa_doc,"onUpdate:value":l[6]||(l[6]=a=>e.is_qa_doc=a)},{default:n(()=>[t(ee,{value:0},{default:n(()=>[b("普通文档")]),_:1}),t(ee,{value:1},{default:n(()=>[b("QA文档")]),_:1})]),_:1},8,["value"])]),_:1}),e.is_qa_doc==1?(d(),q(i,{key:0,label:"索引方式",required:""},{default:n(()=>[c("div",ra,[(d(!0),v(M,null,E(G.value,a=>(d(),v("div",{class:R(["type-item",{active:e.qa_index_type==a.value}]),key:a.value,onClick:f=>ce(a.value)},[c("div",da,[c("div",ca,[t(_,{name:e.qa_index_type==a.value?a.iconNameActive:a.iconName},null,8,["name"]),c("div",_a,w(a.title),1)]),c("div",ua,w(a.desc),1)]),e.qa_index_type==a.value?(d(),q(_,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):j("",!0)],10,sa))),128))])]),_:1})):j("",!0)],512),[[V,e.doc_type==3]]),t(i,A({label:"嵌入模型 "},k(u).use_model),{default:n(()=>[c("div",ma,[(d(!0),v(M,null,E(T.value,a=>(d(),v("div",{class:R(["use-model-item",{active:x.value==a.value}]),key:a.value,onClick:f=>se(a)},[c("div",{class:R(["use-model-item-top",{active:x.value==a.value}])},[t(_,{class:"use-model-item-top-icon",style:{color:"red"},name:x.value==a.value?a.iconNameActive:a.iconName},null,8,["name"]),c("p",null,w(a.title),1)],2),c("p",null,w(a.desc),1),x.value==a.value?(d(),q(_,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):j("",!0)],10,pa))),128))]),t(Z,{value:e.use_model,"onUpdate:value":l[7]||(l[7]=a=>e.use_model=a),placeholder:"请选择嵌入模型",onChange:ie},{default:n(()=>[(d(!0),v(M,null,E(P.value,a=>(d(),q(ye,{key:a.id},{label:n(()=>[t(ve,{align:"center",gap:6},{default:n(()=>[c("img",{class:"model-icon",src:a.icon,alt:""},null,8,fa),b(w(a.name),1)]),_:2},1024)]),default:n(()=>[(d(!0),v(M,null,E(a.children,f=>(d(),q(h,{value:L.indexOf(a.model_define)>-1&&f.deployment_name?f.deployment_name:f.name+f.id,model_config_id:a.id,current_obj:f,key:f.name+f.id},{default:n(()=>[L.indexOf(a.model_define)>-1&&f.deployment_name?(d(),v("span",va,w(f.deployment_name),1)):(d(),v("span",ya,w(f.name),1))]),_:2},1032,["value","model_config_id","current_obj"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},16),t(i,{"wrapper-col":{span:14,offset:4}},{default:n(()=>[t(ae,{onClick:_e},{default:n(()=>[b("取 消")]),_:1}),t(ae,{type:"primary",style:{"margin-left":"16px"},loading:O.value,onClick:Se(ue,["prevent"])},{default:n(()=>[b("下一步")]),_:1},8,["loading"])]),_:1})]),_:1})])])}}},to=te(ga,[["__scopeId","data-v-7010608b"]]);export{to as default};
