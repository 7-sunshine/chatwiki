import{r as f,A as J,v as N,w as Y,L as i,M as u,V as e,j as y,Q as I,F as O,a1 as R,u as z,P as K,X as F,Y as C,af as Z,a2 as ge,E as j,a3 as U,a4 as V,a8 as M,y as X,a0 as he,a6 as ye,B as Se}from"./vue-chunks-DrvJJrR0.js";import{m as T,d as be,_ as q,B as Te}from"../../index-1XZddRjh.js";import{a as ke,_ as $e}from"./RadioButton-BlkUcbKS.js";import{R as xe}from"./dayjs-VjPii4OM.js";import{_ as ee}from"./empty-DkpCLaix.js";import{_ as De,u as we}from"./chat-CUKZ3DYs.js";import{S as Ce}from"./index-DoaGtGTF.js";import{u as Ee}from"./robot-Ch71DfGE.js";import{S as Le,_ as He}from"./index-Xdyh2PDp.js";import{_ as Ie}from"./Search-CBq09XDz.js";import{_ as Be}from"./index-CGIhWGiI.js";import"./dayjs-Bv4VEw_C.js";import"./axios-Cm0UX6qg.js";import"./qs-QntUJHOZ.js";import"./crypto-js-BpV8n4kc.js";import"./FormItemContext-Ddh0y1W5.js";import"./colors-HGJN4rtO.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./CheckOutlined-DhJk9Bd7.js";import"./shallowequal-CfnxU2uU.js";import"./index-BX9E5auJ.js";import"./move-BfDFh-Ii.js";import"./slide-DiBPL1Vu.js";import"./index-BY3kojOB.js";import"./index-D_WNH-ME.js";import"./index-7lPW-8Mv.js";import"./DownOutlined-B1nKfHNN.js";import"./SearchOutlined-Bmx9sA_A.js";import"./Input-LEQ1nsBA.js";import"./inputProps-CcY99FcL.js";const Me={class:"zm-date"},Oe={class:"date-btn"},Ae={class:"date-content"},Re={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(n,{emit:x}){const S=n,_=f(1),m=x;let g=J([{label:"今日",value:!0,key:2,start_time:T().startOf("day"),end_time:T().endOf("day")},{label:"昨日",value:!1,key:3,start_time:T().subtract(1,"day").startOf("day"),end_time:T().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:T().subtract(6,"day").startOf("day"),end_time:T().endOf("day").subtract(1,"millisecond")}]);const d=f(null),a=f(null),s=f([]),h=r=>r>=T().subtract(0,"day"),k=()=>{let r=_.value,o=null;g.forEach(p=>{p.key==r&&(o=p)}),o&&(s.value=[o.start_time,o.end_time],d.value=o.start_time.unix(),a.value=o.end_time.unix()),E()},L=r=>{const o=T(r[0]).startOf("day");if(T(r[1]).endOf("day").diff(o,"days")>29)s.value[0]=r[0].startOf("day"),s.value[1]=o.add(29,"days").endOf("day"),d.value=s.value[0].unix(),a.value=s.value[1].unix(),be.error("最多只能选择30天");else{const b=T(r[0]).startOf("day").unix(),l=T(r[1]).endOf("day").unix();s.value=r,d.value=b,a.value=l}_.value=1,E()},E=()=>{m("dateChange",{start_time:d.value,end_time:a.value})};return N(()=>{_.value=parseInt(S.datekey),k()}),Y(()=>S.datekey,(r,o)=>{_.value=parseInt(S.datekey.split("-")[0]),k()}),(r,o)=>{const p=ke,b=$e,l=xe;return i(),u("div",Me,[e("div",Oe,[y(b,{value:_.value,"onUpdate:value":o[0]||(o[0]=t=>_.value=t),onChange:k},{default:I(()=>[(i(!0),u(O,null,R(z(g),t=>(i(),K(p,{class:"date-btn-button",value:t.key,key:t.key},{default:I(()=>[F(C(t.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",Ae,[y(l,{value:s.value,"onUpdate:value":o[1]||(o[1]=t=>s.value=t),onChange:L,format:"YYYY-MM-DD",disabledDate:h,allowClear:!1},null,8,["value"])])])}}},W=n=>(U("data-v-e837d5ae"),n=n(),V(),n),Ue={key:0,class:"empty-box"},Ve=W(()=>e("img",{src:ee,alt:""},null,-1)),qe=W(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),Pe=[Ve,qe],ze=["onClick"],je={class:"user-item-left"},Ne=["src"],Ye={class:"user-item-right"},Fe={class:"user-name-box"},We={class:"user-name"},Ge={class:"user-timer"},Qe={class:"user-info"},Xe={class:"user-source-box"},Je=W(()=>e("div",{class:"user-source-title"},"来自：",-1)),Ke={class:"user-source-content"},Ze={__name:"user",props:{userList:{type:Array,default:[]}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(n,{emit:x}){const S=f(null),_=n,m=x,g=f([]),d=f({}),a=o=>{d.value=o,m("userClick",o)},s={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let h=null;function k(o){h&&(clearTimeout(h),h=null),h=setTimeout(()=>{s.scrollTop-o.target.scrollTop>0&&(s.scrollDirection="up"),s.scrollTop-o.target.scrollTop<0&&(s.scrollDirection="down"),s.scrollTop=o.target.scrollTop,s.scrollHeight=o.target.scrollHeight,s.clientHeight=o.target.clientHeight,m("userScroll",{...s}),Math.abs(s.scrollTop)<=s.scrollStartDiff+100&&s.scrollDirection==="up"&&L(),Math.abs(s.scrollHeight-s.scrollTop-s.clientHeight)<=s.scrollEndDiff&&s.scrollDirection==="down"&&E()},50)}function L(){_.userList.length!=0&&m("userScrollStart",{msg:_.userList[0]})}function E(){_.userList.length!=0&&m("userScrollEnd",{msg:_.userList[_.userList.length-1]})}Y(()=>_.userList,o=>{g.value=o,g.value.length>0&&g.value.length<=20&&(a(g.value[0]),d.value=g.value[0])},{immediate:!0});const r=o=>{let p;switch(o){case"yun_h5":p="WebAPP";break;case"yun_pc":p="嵌入网站";break}return p};return N(()=>{g.value=_.userList}),(o,p)=>{const b=Z("ftime");return i(),u("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:S,onScroll:k},[g.value.length===0?(i(),u("div",Ue,Pe)):(i(!0),u(O,{key:1},R(g.value,l=>(i(),u("div",{class:ge(["user-item",{active:l.openid==d.value.openid}]),onClick:t=>a(l),key:l.session_id},[e("div",je,[e("img",{class:"user-img",src:l.avatar,alt:""},null,8,Ne)]),e("div",Ye,[e("div",Fe,[e("div",We,C(l.name),1),j((i(),u("div",Ge,[F(C(l.last_chat_time),1)])),[[b,"MM-DD HH:mm"]])]),e("div",Qe,C(l.last_chat_message),1),e("div",Xe,[Je,e("div",Ke,C(r(l.app_type)),1)])])],10,ze))),128))],544)}}},et=q(Ze,[["__scopeId","data-v-e837d5ae"]]),te=n=>(U("data-v-17031fe1"),n=n(),V(),n),tt={class:"message-box"},st={class:"message-top-box"},ot={class:"message-top-title"},at={key:0,class:"message-top-source"},lt={class:"message-list"},nt={key:0,class:"empty-box"},rt=te(()=>e("img",{src:ee,alt:""},null,-1)),ct=te(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),it=[rt,ct],ut=["id"],_t={class:"itme-right"},dt={class:"item-body"},pt={class:"message-content"},mt={class:"user-avatar-box"},vt=["src"],ft=["id"],gt={class:"itme-left"},ht=["src"],yt={class:"itme-right"},St={class:"item-body"},bt={key:0,class:"message-content"},Tt=["innerHTML"],kt={key:2,class:"message-content"},$t=["src"],xt={key:2,class:"loading-box"},Dt={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null}},emits:["scroll","scrollStart","scrollEnd"],setup(n,{expose:x,emit:S}){const _=S,m=n,g=f(!1),d=f(null),a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let s=null,h=!1;const k=l=>{let t;switch(l){case"yun_h5":t="WebAPP";break;case"yun_pc":t="嵌入网站";break}return t};function L(l){h||(s&&(clearTimeout(s),s=null),s=setTimeout(()=>{a.scrollTop-l.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-l.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=l.target.scrollTop,a.scrollHeight=l.target.scrollHeight,a.clientHeight=l.target.clientHeight,_("scroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff&&a.scrollDirection==="up"&&E(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&r()},100))}function E(){m.messages.length!=0&&_("scrollStart",{msg:m.messages[0]})}function r(){m.messages.length!=0&&_("scrollEnd",{msg:m.messages[m.messages.length-1]})}const o=()=>{d.value&&X(()=>{h=!0,d.value.scrollTop=d.value.scrollHeight+1,setTimeout(()=>{a.scrollTop=d.value.scrollTop,h=!1},50)})};function p(l,t){X(()=>{h=!0,t||(t="top");let $=d.value,D=document.querySelector("#msg-"+l);D&&(t=="top"?$.scrollTop=D.offsetTop:$.scrollTop=D.offsetTop-$.clientHeight+D.clientHeight),setTimeout(()=>{a.scrollTop=d.value.scrollTop,h=!1},50)})}function b(){a.scrollTop=0,a.scrollDirection=""}return x({scrollToBottom:o,scrollToMessage:p,resetScroll:b}),(l,t)=>{const $=Ce,D=Z("viewer");return i(),u("div",tt,[e("div",st,[e("div",ot,C(m.robotInfo.robot_name),1),n.sessionSource?(i(),u("div",at,"("+C(k(n.sessionSource))+")",1)):M("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:d,onScroll:L},[e("div",lt,[m.isEmpty||!m.messages?(i(),u("div",nt,it)):(i(!0),u(O,{key:1},R(m.messages,v=>(i(),u(O,{key:v.uid},[v.is_customer==1?(i(),u("div",{key:0,class:"message-item user-message",id:"msg-"+v.uid},[e("div",_t,[e("div",dt,[e("div",pt,C(v.content),1)])]),e("div",mt,[e("img",{class:"user-avatar",src:v.avatar},null,8,vt)])],8,ut)):(i(),u("div",{key:1,class:"message-item robot-message",id:"msg-"+v.uid},[e("div",gt,[y($,{size:"small",spinning:v.loading},{default:I(()=>[e("img",{class:"robot-avatar",src:v.robot_avatar},null,8,ht)]),_:2},1032,["spinning"])]),e("div",yt,[e("div",St,[v.msg_type==1?j((i(),u("div",bt,[y(De,{content:v.content},null,8,["content"])])),[[D]]):M("",!0),v.msg_type==2?(i(),u("div",{key:1,class:"message-content",innerHTML:v.menu_json.content},null,8,Tt)):M("",!0),v.msg_type==3?(i(),u("div",kt,[j(e("img",{class:"msg-img",src:v.content,alt:""},null,8,$t),[[D]])])):M("",!0)])])],8,ft))],64))),128)),g.value?(i(),u("div",xt,[y($)])):M("",!0)])],544)])}}},wt=q(Dt,[["__scopeId","data-v-17031fe1"]]),se=n=>(U("data-v-526c937e"),n=n(),V(),n),Ct={class:"team-members-pages"},Et={class:"set-model"},Lt=se(()=>e("div",{class:"label set-model-label"},"渠道：",-1)),Ht={class:"set-model-body"},It={class:"set-date"},Bt=se(()=>e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),Mt={class:"set-date-body"},Ot={class:"set-name"},At={class:"set-reset"},Rt={class:"list-box"},Ut={class:"user-box"},Vt={class:"records-box"},qt={__name:"session-record",setup(n){const x=f(!1),S=he(),_=S.query,m=Ee(),{robotInfo:g}=m,d=we(),{messageList:a}=ye(d);let s=!0;const{createMsg:h,onGetChatMessage:k,getRecordList:L,getChannelList:E}=d,r=f(null),o=f([]),p=f([]),b=f(""),l=f("1"),t=J({robot_id:_.id,app_type:"all",app_id:"",start_time:"",end_time:"",name:"",page:1,size:20}),$=f(!1),D=c=>{t.start_time=c.start_time,t.end_time=c.end_time,P()},v=()=>{t.app_type="all",t.name="",t.page=1,l.value="1-"+Math.random()},P=()=>{t.page=1,G()},oe=c=>{t.app_type=c,P()},ae=()=>{},le=c=>{b.value=c.app_type,de(c)},ne=async()=>{},re=()=>{$.value&&(t.page++,G())},ce=async()=>{s=!1;let c=a.value[0].uid;await k()&&ue(c)},ie=()=>{r.value&&s&&r.value.scrollToBottom()},ue=c=>{r.value&&r.value.scrollToMessage(c)},_e=()=>{r.value&&r.value.resetScroll()};let A=null;const de=async c=>{s=!0;let B={robot_key:(S.query||{}).robot_key,avatar:c.avatar,name:c.name,nickname:c.name,is_background:1,openid:c.openid,dialogue_id:c.dialogue_id};_e(),await h(B),A&&(clearTimeout(A),A=null),A=setTimeout(async()=>{await k()&&ie()},100)},pe=async()=>{const c=await E();o.value=[{app_type:"all",app_name:"全部渠道"},...c.data]},G=async()=>{let c={robot_id:t.robot_id,start_time:t.start_time,end_time:t.end_time,name:t.name,page:t.page,size:t.size};t.app_type!=="all"&&(c.app_type=t.app_type);let w=await L(c),B=w.data.list||[];t.page==1&&(p.value=[]),p.value=[...p.value,...B],x.value=p.value.length==0,$.value=w.data.has_more};return Y(()=>a.value,()=>{}),N(async()=>{pe()}),Se(()=>{}),(c,w)=>{const B=Le,Q=He,me=Ie,ve=Te,fe=Be;return i(),u("div",Ct,[y(fe,{justify:"flex-start",class:"screen-box"},{default:I(()=>[e("div",Et,[Lt,e("div",Ht,[y(Q,{value:t.app_type,"onUpdate:value":w[0]||(w[0]=H=>t.app_type=H),placeholder:"全部渠道",onChange:oe,style:{width:"200px"}},{default:I(()=>[(i(!0),u(O,null,R(o.value,H=>(i(),K(B,{key:H.app_type,value:H.app_type},{default:I(()=>[e("span",null,C(H.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",It,[Bt,e("div",Mt,[y(Re,{onDateChange:D,datekey:l.value},null,8,["datekey"])])]),e("div",Ot,[y(me,{value:t.name,"onUpdate:value":w[1]||(w[1]=H=>t.name=H),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:P},null,8,["value"])]),e("div",At,[y(ve,{onClick:v},{default:I(()=>[F("重置")]),_:1})])]),_:1}),e("div",Rt,[e("div",Ut,[y(et,{userList:p.value,onUserScrollStart:ne,onUserScrollEnd:re,onUserClick:le},null,8,["userList"])]),e("div",Vt,[y(wt,{ref_key:"messageListRef",ref:r,isEmpty:x.value,messages:z(a),robotInfo:z(g),sessionSource:b.value,onScrollStart:ce,onScrollEnd:ae},null,8,["isEmpty","messages","robotInfo","sessionSource"])])])])}}},Pt=q(qt,[["__scopeId","data-v-526c937e"]]),zt=n=>(U("data-v-bcc51f14"),n=n(),V(),n),jt={class:"user-model-page"},Nt=zt(()=>e("div",{class:"page-title"},"会话记录",-1)),Yt={class:"list-wrapper"},Ft={__name:"index",setup(n){return(x,S)=>(i(),u("div",jt,[Nt,e("div",Yt,[y(Pt)])]))}},ks=q(Ft,[["__scopeId","data-v-bcc51f14"]]);export{ks as default};
