import{_ as te,L as ye,d as z,M as he,aF as Y,aG as be,af as ke,ag as we,c as xe,B as qe}from"../../index-BRxqhTX0.js";import{e as p,w as Ne,M as d,N as u,a9 as D,k as t,S as n,W as c,Q as N,u as q,a4 as le,a5 as ne,a0 as Ce,B as H,x as Ae,V as A,F as j,a2 as E,a3 as R,Z as x,G as T,H as V,Y as w,a8 as Se}from"./vue-chunks-Chs-lyDX.js";import{U as Fe}from"./upload-input-D4p3GPcH.js";import{c as Ue}from"./index-ClsKim4H.js";import{b as Ie}from"./index-DwMlK7BC.js";import{F as W,_ as Oe}from"./index-BpmDo9gD.js";import{P as Le}from"./PlusOutlined-BsuTPPYk.js";import{_ as Pe}from"./index-DB-QVbQ9.js";import{t as oe}from"./validate-CYzfr11z.js";import"./index-BxFCEOhs.js";import{I as Me}from"./Password-IO9yCNMV.js";import{R as je,_ as Ee}from"./index-DW1R_2r3.js";import{_ as De}from"./TextArea-DXf3OI0w.js";import{S as $e,_ as Be,a as Re}from"./index-DvlsFstf.js";import{_ as Te}from"./index-bokNoDeU.js";import"./dayjs-CkLU8sYs.js";import"./axios-Cm0UX6qg.js";import"./qs-DjYKlG5V.js";import"./crypto-js-BUUKnz8c.js";import"./index-BKmN8VmO.js";import"./collapseMotion-DN2MDQ98.js";import"./QuestionCircleOutlined-D20_EtSI.js";import"./FormItemContext-VrUvw7Ec.js";import"./CheckOutlined-CvMo00tT.js";import"./useRefs-BsXgmhaJ.js";import"./inputProps-C625v0VH.js";import"./index-DYUnQ0Fx.js";import"./slide-Dp7-2q38.js";import"./DownOutlined-bMEBWO_G.js";import"./move-DuzEngAP.js";const Ve=m=>(le("data-v-c59d7bc3"),m=m(),ne(),m),ze={class:"avatar-uploader"},Ge=["src"],Je=Ve(()=>c("div",{class:"ant-upload-text"},"上传照片",-1)),Qe=["src"],Ye={__name:"avatar-input",props:{value:{type:String,default:""}},emits:["update:value","change"],setup(m,{emit:G}){function $(i){return new Promise((C,v)=>{const k=new FileReader;k.readAsDataURL(i),k.onload=()=>C(k.result),k.onerror=P=>v(P)})}const I=G,O=m,S=p([]),B=p(!1),L=p("");Ne(()=>O.value,i=>{L.value=i},{immediate:!0});const J=W.useInjectFormItemContext(),F=()=>{let i={imageUrl:L.value,file:S.value[0].originFileObj};I("change",i),I("update:value",i.imageUrl),J.onFieldChange()},f=i=>i.type==="image/jpeg"||i.type==="image/png"?i.size/1024<100?(S.value=[i],$(i).then(k=>{L.value=k,B.value=!1,F()}),!1):(z.error("知识库封面图片大小不能超过100kb"),!1):(z.error("知识库封面只支持JPG、PNG格式的图片"),!1),b=p(!1),e=p(""),U=p(""),X=()=>{b.value=!1,U.value=""},Z=async i=>{!i.url&&!i.preview&&(i.preview=await $(i.originFileObj)),e.value=i.url||i.preview,b.value=!0,U.value=i.name||i.url.substring(i.url.lastIndexOf("/")+1)};return(i,C)=>{const v=Pe,k=he;return d(),u("div",ze,[m.value?(d(),u("img",{key:0,class:"avatar",src:m.value,alt:"avatar"},null,8,Ge)):D("",!0),t(v,{class:"upload-upload","file-list":S.value,"onUpdate:fileList":C[0]||(C[0]=P=>S.value=P),"list-type":"picture-card","show-upload-list":!1,"before-upload":f,accept:".jpg,.png,.jpeg",onPreview:Z},{default:n(()=>[c("div",null,[B.value?(d(),N(q(ye),{key:0})):(d(),N(q(Le),{key:1})),Je])]),_:1},8,["file-list"]),t(k,{open:b.value,title:U.value,footer:null,onCancel:X},{default:n(()=>[c("img",{alt:"example",style:{width:"100%"},src:e.value},null,8,Qe)]),_:1},8,["open","title"])])}}},He=te(Ye,[["__scopeId","data-v-c59d7bc3"]]),We=m=>(le("data-v-b2faed0f"),m=m(),ne(),m),Xe={class:"add-library-page"},Ze={class:"form-box"},Ke=We(()=>c("div",{class:"form-item-tip"},"请上传知识库封面，建议尺寸为100*100px.大小不超过100kb",-1)),ea={class:"upload-document-type-box"},aa=["onClick"],oa={class:"right-block"},ta={class:"title-block"},la={class:"title-text"},na={class:"desc"},ia={class:"upload-document-type-box"},ra=["onClick"],sa={class:"right-block"},da={class:"title-block"},ca={class:"title-text"},_a={class:"desc"},ua={class:"card-box"},pa=["onClick"],ma=["src"],fa={key:0},va={key:1},ga={__name:"add-library",setup(m){const{getStorage:G,setStorage:$}=be("localStorage");z.config({duration:2});const I=Ce(),O=["azure","ollama","xinference","openaiAgent"],S=p([{iconName:"high",iconNameActive:"high-active",title:"高质量",value:1,is_offline:!1,desc:"使用在线的嵌入模型，在召回时具有更高的准确度，但需要花费token"},{iconName:"economic",iconNameActive:"economic-active",title:"经济",value:2,is_offline:!0,desc:"使用离线的向量模型，较在线模型准确度稍低，但是不需要消耗token"}]),B=p([{iconName:"doc-icon",iconNameActive:"doc-icon-active",title:"本地文档",value:1,desc:"上传本地 text/pdf/doc/docx/xlsx 等格式文件"},{iconName:"link-icon",iconNameActive:"link-icon-active",title:"在线数据",value:2,desc:"获取在线网页内容"},{iconName:"cu-doc-icon",iconNameActive:"cu-doc-active",title:"自定义文档",value:3,desc:"自定义一个空文档，手动添加或编辑内容"}]),L=p([{iconName:"file-search",iconNameActive:"file-search",title:"问题与答案一起生成索引",value:1,desc:"回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复"},{iconName:"comment-search",iconNameActive:"comment-search",title:"仅对问题生成索引",value:2,desc:"回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复"}]),J=W.useForm,F=p(!1),f=H(G("lastEmbeddedModel")||{}),b=p(f.isActive?f.isActive:2),e=H({library_name:"",library_intro:"",use_model:f.use_model?f.use_model:void 0,model_config_id:f.model_config_id?f.model_config_id:"",library_files:void 0,avatar:Y,robot_avatar_url:Y,is_offline:Object.prototype.hasOwnProperty.call(f,"is_offline")?f.is_offline:!1,urls:"",doc_type:1,file_name:"",is_qa_doc:0,qa_index_type:1,doc_auto_renew_frequency:1}),U=p(""),i=H({library_name:[{required:!0,message:"请输入库名称",trigger:"change"}],library_intro:[{required:!0,message:"请输入库简介",trigger:"change"}],use_model:[{required:!0,message:"请选择嵌入模型",trigger:"change"}],library_files:[{required:!0,message:"请选择文件",trigger:"change",validator:(o,l)=>l&&l.length>0||e.doc_type!=1?Promise.resolve():Promise.reject(new Error("请上传文件"))}],urls:[{required:!0,validator:(o,l)=>e.doc_type!=2?Promise.resolve():oe(l)===!1?Promise.reject(new Error("网页地址不合法")):Promise.resolve()}],file_name:[{required:!0,validator:(o,l)=>e.doc_type!=3||l?Promise.resolve():Promise.reject(new Error("请输入文档名称"))}]}),{validate:C,validateInfos:v}=J(e,i),k=o=>{e.library_files=o},P=(o,l)=>{U.value=l.current_obj.model_define,e.model_config_id=l.current_obj.id||l.model_config_id},ie=o=>{e.avatar=o.file},re=o=>{e.is_offline=o.is_offline,b.value=o.value,e.use_model=void 0,Q(o.is_offline)},se=o=>{e.doc_type=o},de=o=>{e.qa_index_type=o},ce=()=>{I.back()},_e=()=>{C().then(()=>{ue()}).catch(o=>{})},ue=()=>{let o=new FormData,l=JSON.parse(JSON.stringify(e));O.indexOf(U.value)>-1&&(l.use_model="默认"),o.append("library_name",e.library_name),o.append("library_intro",e.library_intro),o.append("use_model",l.use_model),o.append("model_config_id",e.model_config_id),o.append("avatar",e.avatar||Y),o.append("is_offline",e.is_offline),o.append("urls",JSON.stringify(oe(e.urls))),o.append("doc_type",e.doc_type),o.append("file_name",e.file_name),o.append("is_qa_doc",e.is_qa_doc),o.append("qa_index_type",e.qa_index_type),o.append("doc_auto_renew_frequency",e.doc_auto_renew_frequency),$("lastEmbeddedModel",{model_config_id:e.model_config_id,is_offline:e.is_offline,use_model:e.use_model,isActive:b.value}),e.doc_type==1&&e.library_files.forEach(h=>{o.append("library_files",h)}),F.value=!0,Ue(o).then(h=>{z.success("创建成功");let r="/library/document-segmentation",s={document_id:h.data.file_ids[0]};e.doc_type==3&&(r="/library/preview",s={id:h.data.file_ids[0]}),I.replace({path:r,query:s}),F.value=!1}).catch(()=>{F.value=!1})},M=p([]);function pe(o,l,h){const r=new Set(o.map(s=>s.model_define));return l.filter(s=>{let _=s[h];r.has(_)&&o.filter(g=>{if(g.model_define==_)return g.children=we(g.children,s.children),!1})}),o}const Q=o=>{Ie({model_type:"TEXT EMBEDDING",is_offline:o}).then(l=>{let h=l.data||[],r=[];M.value=h.map(s=>{r=[];for(let _=0;_<s.model_info.vector_model_list.length;_++){const g=s.model_info.vector_model_list[_];r.push({name:g,deployment_name:s.model_config.deployment_name,id:s.model_config.id,model_define:s.model_info.model_define})}return{id:s.model_config.id,name:s.model_info.model_name,model_define:s.model_info.model_define,icon:s.model_info.model_icon_url,children:r,deployment_name:s.model_config.deployment_name}}),M.value=pe(ke(M.value,"model_define"),M.value,"model_define")})};return Ae(()=>{Object.prototype.hasOwnProperty.call(f,"is_offline")?Q(f.is_offline):Q(!0)}),(o,l)=>{const h=Me,r=Oe,s=De,_=xe,g=$e,K=Be,ee=je,me=Ee,fe=Te,ve=Re,ae=qe,ge=W;return d(),u("div",Xe,[c("div",Ze,[t(ge,{"label-col":{span:5}},{default:n(()=>[t(r,A({ref:"name",label:"知识库名称"},q(v).library_name),{default:n(()=>[t(h,{value:e.library_name,"onUpdate:value":l[0]||(l[0]=a=>e.library_name=a),placeholder:"请输入知识库名称，最多20个字"},null,8,["value"])]),_:1},16),t(r,A({label:"知识库简介"},q(v).library_intro),{default:n(()=>[t(s,{value:e.library_intro,"onUpdate:value":l[1]||(l[1]=a=>e.library_intro=a),placeholder:"请输入知识库介绍"},null,8,["value"])]),_:1},16),t(r,A({ref:"name",label:"知识库封面"},q(v).robot_avatar_url),{default:n(()=>[t(He,{value:e.robot_avatar_url,"onUpdate:value":l[2]||(l[2]=a=>e.robot_avatar_url=a),onChange:ie},null,8,["value"]),Ke]),_:1},16),t(r,{label:"导入文档类型",required:""},{default:n(()=>[c("div",ea,[(d(!0),u(j,null,E(B.value,a=>(d(),u("div",{class:R(["type-item",{active:e.doc_type==a.value}]),key:a.value,onClick:y=>se(a.value)},[c("div",oa,[c("div",ta,[t(_,{name:e.doc_type==a.value?a.iconNameActive:a.iconName},null,8,["name"]),c("div",la,x(a.title),1)]),c("div",na,x(a.desc),1)]),e.doc_type==a.value?(d(),N(_,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):D("",!0)],10,aa))),128))])]),_:1}),T(t(r,A({ref:"name",label:"知识库文档"},q(v).library_files),{default:n(()=>[t(Fe,{onChange:k})]),_:1},16),[[V,e.doc_type==1]]),T(t(r,A({ref:"urls",label:"网页链接"},q(v).urls),{default:n(()=>[t(s,{style:{height:"120px"},value:e.urls,"onUpdate:value":l[3]||(l[3]=a=>e.urls=a),placeholder:"请输入网页链接,形式：一行标题一行网页链接"},null,8,["value"])]),_:1},16),[[V,e.doc_type==2]]),T(t(r,{ref:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:n(()=>[t(K,{value:e.doc_auto_renew_frequency,"onUpdate:value":l[4]||(l[4]=a=>e.doc_auto_renew_frequency=a),style:{width:"100%"}},{default:n(()=>[t(g,{value:1},{default:n(()=>[w("不自动更新")]),_:1}),t(g,{value:2},{default:n(()=>[w("每天")]),_:1}),t(g,{value:3},{default:n(()=>[w("每3天")]),_:1}),t(g,{value:4},{default:n(()=>[w("每7天")]),_:1}),t(g,{value:5},{default:n(()=>[w("每30天")]),_:1})]),_:1},8,["value"])]),_:1},512),[[V,e.doc_type==2]]),T(c("div",null,[t(r,A({ref:"file_name",label:"文档名称"},q(v).file_name),{default:n(()=>[t(h,{placeholder:"请输入文档名称",value:e.file_name,"onUpdate:value":l[5]||(l[5]=a=>e.file_name=a)},null,8,["value"])]),_:1},16),t(r,{label:"文档类型",required:""},{default:n(()=>[t(me,{value:e.is_qa_doc,"onUpdate:value":l[6]||(l[6]=a=>e.is_qa_doc=a)},{default:n(()=>[t(ee,{value:0},{default:n(()=>[w("普通文档")]),_:1}),t(ee,{value:1},{default:n(()=>[w("QA文档")]),_:1})]),_:1},8,["value"])]),_:1}),e.is_qa_doc==1?(d(),N(r,{key:0,label:"索引方式",required:""},{default:n(()=>[c("div",ia,[(d(!0),u(j,null,E(L.value,a=>(d(),u("div",{class:R(["type-item",{active:e.qa_index_type==a.value}]),key:a.value,onClick:y=>de(a.value)},[c("div",sa,[c("div",da,[t(_,{name:e.qa_index_type==a.value?a.iconNameActive:a.iconName},null,8,["name"]),c("div",ca,x(a.title),1)]),c("div",_a,x(a.desc),1)]),e.qa_index_type==a.value?(d(),N(_,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):D("",!0)],10,ra))),128))])]),_:1})):D("",!0)],512),[[V,e.doc_type==3]]),t(r,A({label:"嵌入模型 "},q(v).use_model),{default:n(()=>[c("div",ua,[(d(!0),u(j,null,E(S.value,a=>(d(),u("div",{class:R(["use-model-item",{active:b.value==a.value}]),key:a.value,onClick:y=>re(a)},[c("div",{class:R(["use-model-item-top",{active:b.value==a.value}])},[t(_,{class:"use-model-item-top-icon",style:{color:"red"},name:b.value==a.value?a.iconNameActive:a.iconName},null,8,["name"]),c("p",null,x(a.title),1)],2),c("p",null,x(a.desc),1),b.value==a.value?(d(),N(_,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):D("",!0)],10,pa))),128))]),t(K,{value:e.use_model,"onUpdate:value":l[7]||(l[7]=a=>e.use_model=a),placeholder:"请选择嵌入模型",onChange:P},{default:n(()=>[(d(!0),u(j,null,E(M.value,a=>(d(),N(ve,{key:a.id},{label:n(()=>[t(fe,{align:"center",gap:6},{default:n(()=>[c("img",{class:"model-icon",src:a.icon,alt:""},null,8,ma),w(x(a.name),1)]),_:2},1024)]),default:n(()=>[(d(!0),u(j,null,E(a.children,y=>(d(),N(g,{value:O.indexOf(a.model_define)>-1&&y.deployment_name?y.deployment_name:y.name,model_config_id:a.id,current_obj:y,key:y.name+y.id},{default:n(()=>[O.indexOf(a.model_define)>-1&&y.deployment_name?(d(),u("span",fa,x(y.deployment_name),1)):(d(),u("span",va,x(y.name),1))]),_:2},1032,["value","model_config_id","current_obj"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},16),t(r,{"wrapper-col":{span:14,offset:4}},{default:n(()=>[t(ae,{onClick:ce},{default:n(()=>[w("取 消")]),_:1}),t(ae,{type:"primary",style:{"margin-left":"16px"},loading:F.value,onClick:Se(_e,["prevent"])},{default:n(()=>[w("下一步")]),_:1},8,["loading"])]),_:1})]),_:1})])])}}},Ya=te(ga,[["__scopeId","data-v-b2faed0f"]]);export{Ya as default};
